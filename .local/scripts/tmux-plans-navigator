#!/usr/bin/env bash

# Loads the .plans directory in a tmux window

find_plans_dir() {
    local current_dir="$1"

    while [[ "$current_dir/.plans" ]]; do
        if [[ -d "$current_dir/.plans" ]]; then
            echo "$current_dir/.plans"
            return 0
        fi
        current_dir=$(dirname "$current_dir")
    done

    return 1
}

current_path=$(tmux display-message -p '#{pane_current_path}')

if plans_dir=$(find_plans_dir "$current_path"); then
    current_window=$(tmux display-message -p '#{window_name}')

    if [[ "$current_window" == "plans" ]]; then
        tmux last-window
    else
        if ! tmux select-window -t plans 2>/dev/null; then
            tmux new-window -c "$plans_dir" -n plans "nvim ."
        fi
    fi
else
    tmux display-message "No .plans directory found in current project"
fi
